# 【Art-Pi 2】基于 RT-Thread + Air780e 的工业级环境与姿态云监测系统

## 目录

- [应用实现功能](#应用实现功能)
- [RT-Thread 使用情况概述](#rt-thread-使用情况概述)
- [硬件框架](#硬件框架)
- [软件框架说明](#软件框架说明)
- [演示效果](#演示效果)
- [代码地址](#代码地址)
- [总结与优化](#总结与优化)

---

## 应用实现功能

- **多维姿态解算**：通过串口对接 JY61P 6轴传感器，实时解析加速度与角速度数据，解算并输出设备的 Roll（翻滚角）、Pitch（俯仰角）、Yaw（偏航角）。

- **环境数据采集**：利用单总线驱动读取 DHT11 温湿度数据；利用 ADC 读取 MQ-2 烟雾传感器电压值，实现对环境状况的全面感知。

- **危险报警机制**：系统内置逻辑判断，当烟雾浓度（电压值）超过安全阈值时，触发系统级事件报警，并在终端高亮提示。

- **4G 云端遥测**：集成 Air780e 4G Cat.1 模组，将采集到的传感器数据通过 UART 转发至云平台（如 TCP/UDP 服务器或 MQTT Broker），实现远程物联网监控。

- **交互式调试**：除了周期性的仪表盘显示外，支持通过 MSH (FinSH) 命令行输入指令，随时抓取当前传感器的"快照"数据，便于开发调试。

---

## RT-Thread 使用情况概述

### 多线程管理 (Thread)

| 线程名 | 优先级 | 功能 |
|--------|--------|------|
| `jy_th` | 高 | IMU 数据解析线程，保证姿态解算的实时性 |
| `col_th` | 中 | 综合业务线程，负责环境数据轮询、数据打包、报警判断以及 4G 数据发送 |

### 进程间通信 (IPC)

- **互斥量 (Mutex)**：使用 `rt_mutex` 保护全局共享结构体 `global_data`，解决了 IMU 高频写入与采集发送线程读取之间的竞争问题，防止数据撕裂。

- **信号量 (Semaphore)**：配合 UART 中断使用 `rt_sem`，实现 JY61P 数据的异步接收，极大降低 CPU 占用率。

- **事件集 (Event)**：使用 `rt_event` 实现异常状态（如烟雾报警）的跨线程通知。

### 设备驱动框架 (Device Drivers)

- **UART 设备**：分别驱动 JY61P (UART1) 和 Air780e (UART4)
- **ADC 设备**：标准化调用读取 MQ-2 模拟量
- **Sensor 框架**：使用 RTT 标准 Sensor 驱动对接 DHT11

### 系统组件

- **自动初始化**：使用 `INIT_APP_EXPORT` 自动加载应用模块
- **MSH Shell**：使用 `MSH_CMD_EXPORT` 导出调试命令

---

## 硬件框架

| 硬件 | 功能 | 连接方式 |
|------|------|----------|
| Art-Pi 2 (STM32H7RS) | 运行 RT-Thread 内核及业务逻辑 | 核心主控 |
| JY61P (6轴IMU) | 提供加速度、角速度及欧拉角数据 | UART1 (TX/RX) |
| Air780e (4G Cat.1) | 提供广域网连接，数据上云 | UART4 (TX/RX) |
| DHT11 | 采集环境温度与湿度 | GPIO (PI8) |
| MQ-2 气体传感器 | 检测烟雾及可燃气体浓度 | ADC1 Channel 5 (PB1) |
| Type-C 转 TTL | 用于 Shell 交互与日志打印 | LPUART1 (或默认 Console) |

---

## 软件框架说明

### 整体框架介绍

应用采用 **采集-汇聚-分发** 模型。传感器数据由驱动层汇聚至受保护的全局对象中，业务层负责将数据格式化，一方面在本地 Shell 打印，另一方面通过 4G 模组透传至云端。

```
┌─────────────────────────────────────────────────────────┐
│                      应用层 (App)                        │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │
│  │ jy_th   │  │ col_th  │  │  MSH    │  │ Air780e │    │
│  │ (IMU)   │  │ (采集)  │  │ (调试)  │  │ (上云)  │    │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘    │
│       │            │            │            │          │
│       └────────────┴────────────┴────────────┘          │
│                         │                               │
│              ┌──────────▼──────────┐                    │
│              │   global_data       │                    │
│              │   (Mutex 保护)      │                    │
│              └──────────┬──────────┘                    │
├─────────────────────────┼───────────────────────────────┤
│                      驱动层                              │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │
│  │  UART   │  │   ADC   │  │ Sensor  │  │  GPIO   │    │
│  │ (JY61P) │  │ (MQ-2)  │  │ (DHT11) │  │         │    │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘    │
└─────────────────────────────────────────────────────────┘
```

### 软件模块说明

#### 1. 主程序与公共资源模块

- **说明**：负责系统对象的生命周期管理
- **核心功能**：
  - 利用 `INIT_APP_EXPORT` 实现组件化自动启动
  - 初始化系统级 IPC 对象（锁、信号量、事件）
  - 初始化 Air780e 通信接口（UART4）

#### 2. IMU 姿态解算模块 (jy_th)

- **说明**：高优先级线程，负责处理高速串口数据流
- **核心逻辑**：
  - **中断接收**：串口接收到数据触发中断，释放信号量
  - **协议解析**：校验 JY61P 数据包，解析欧拉角
  - **临界区保护**：使用 `rt_mutex_take/release` 确保写入全局变量时的原子性

#### 3. 综合采集与上云模块 (col_th)

- **说明**：系统的业务核心
- **核心逻辑**：
  - **数据快照**：申请互斥锁，快速复制全局数据到本地，减少锁占用时间
  - **环境感知**：调用 Sensor 框架读取 DHT11，调用 ADC 框架读取 MQ-2
  - **报警逻辑**：若 `mq2_vol > 1.0V`，触发报警事件
  - **4G 透传**：将整合后的数据（JSON 或 CSV 格式）通过 UART4 发送给 Air780e 模组

```c
// 伪代码示例
rt_device_write(air780_dev, 0, json_buffer, len);
```

#### 4. MSH 交互模块

- **说明**：调试工具
- **核心功能**：通过 `sensor_dump` 命令，开发人员可以在不连接云端的情况下，直接在串口终端检查传感器是否工作正常

---

## 演示效果

### 1. 本地串口终端展示

系统启动后，周期性打印仪表盘，并提示 4G 发送状态：

```
================ SENSOR MONITOR ================
[Env] Temp: 26 C | Humi: 45 %
[IMU] Pitch: 3.05 | Roll: -1.20 | Yaw: 120.50
[Gas] Raw: 1205 | Volt: 0.60 V
[Net] Uploading data via Air780e... OK
```

### 2. 烟雾报警测试

当检测到高浓度烟雾时：

```
!!! DANGER: SMOKE DETECTED !!!
[Net] Sending ALARM packet to Cloud!
```

### 3. 云端数据接收 (示意)

云平台收到的数据包示例：

```json
{
  "device": "artpi2_001",
  "temp": 26,
  "humi": 45,
  "roll": -1.20,
  "pitch": 3.05,
  "yaw": 120.50,
  "smoke_vol": 0.60
}
```

---

## 代码地址

> 请在此处填写您的代码仓库地址

---

## 总结与优化

本项目展示了如何在 Art-Pi 2 高性能 MCU 上利用 RT-Thread 轻松驾驭多外设协同工作。通过引入 Air780e，成功打通了"端-云"链路。

### 项目亮点

- 充分利用 RT-Thread 的多线程、IPC 机制实现高效的数据采集与处理
- 采用互斥锁保护共享数据，确保多线程环境下的数据一致性
- 模块化设计，便于扩展和维护

### 后续优化方向

- 增加更多传感器支持（如 PM2.5、CO2 等）
- 实现 OTA 远程固件升级
- 添加本地数据存储（SD 卡或 Flash）
- 优化功耗管理，支持低功耗模式
